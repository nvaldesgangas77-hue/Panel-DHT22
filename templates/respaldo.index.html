<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üå°Ô∏è Panel DHT22 ‚Äî Comparador de D√≠as</title>
  <script src="/static/chart.min.js"></script>
  <style>
    :root {
      --bg: #0d1b2a;
      --card: #1b263b;
      --text: #e0e1dd;
      --accent: #00b4d8;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      text-align: center;
      transition: background 0.3s, color 0.3s;
    }

    header {
      background: var(--card);
      color: var(--accent);
      padding: 15px;
      font-size: 1.8em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    main { margin: 20px auto; width: 95%; max-width: 1100px; }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-bottom: 20px;
      transition: background 0.3s;
    }
    canvas {
      background: var(--card);
      border-radius: 16px;
      width: 100%;
      padding: 15px;
      transition: background 0.3s;
    }
    footer { margin-top: 30px; padding: 10px; color: var(--accent); }
    input[type="date"], select {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 6px 10px;
    }

    select {
      font-size: 0.8em;
      margin-left: 10px;
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.3s;
    }
    button:hover { background: var(--text); color: var(--bg); }

    /* Estilos para cuadro en tiempo real */
    .real-time {
      font-size: 2em;
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 30px;
      color: var(--accent);
    }
    .rt-item {
      background: var(--card);
      padding: 15px 25px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.3s ease;
    }
    .rt-item:hover { transform: scale(1.05); }
    .rt-value {
      font-size: 2.2em;
      font-weight: bold;
    }
    .rt-label {
      font-size: 0.9em;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <header>
    üå°Ô∏è Panel DHT22
    <div>
      <label for="tema">üé® Tema:</label>
      <select id="tema">
        <option value="oscuro">Oscuro T√©cnico</option>
        <option value="claro">Claro Moderno</option>
        <option value="eco">Eco Verde</option>
        <option value="solar">Solar</option>
        <option value="nocturno">Nocturno P√∫rpura</option>
        <option value="industrial">Industrial Gris</option>
      </select>
      <button onclick="window.location.href='/logout'">Salir</button>
    </div>
  </header>

  <main>
    <div id="alertaPanel" style="
  display:none;
  background-color:#8b0000;
  color:white;
  padding:10px;
  border-radius:10px;
  margin-bottom:15px;
  font-weight:bold;
  box-shadow:0 4px 12px rgba(0,0,0,0.5);
">
‚ö†Ô∏è Alerta ambiental activa
</div>

    <div class="card">
      <h2>üìä Valores Extremos Globales</h2>
      <div id="extremos">
        üå°Ô∏è M√°x: <span id="tmax">--</span> ¬∞C | M√≠n: <span id="tmin">--</span> ¬∞C <br>
        üíß M√°x: <span id="hmax">--</span> % | M√≠n: <span id="hmin">--</span> % <br><br>
        üå°Ô∏è Promedio: <span id="tmean">--</span> ¬∞C (¬±<span id="tstd">--</span>) |
        üíß Promedio: <span id="hmean">--</span> % (¬±<span id="hstd">--</span>)
      </div>
      <hr style="margin:15px 0; border:1px solid var(--accent); opacity:0.3;">
<h3>üå¶Ô∏è Clima Externo (API Meteorol√≥gica)</h3>
<div id="panelClima" style="
  background:#223040;
  border-radius:12px;
  padding:12px;
  margin-top:10px;
  font-size:1.1em;
  color:#e0e1dd;
  box-shadow:0 4px 12px rgba(0,0,0,0.4);
  transition:background 0.5s ease;">
  <div id="climaExterno">Cargando datos meteorol√≥gicos...</div>
</div>

    </div>

    <div class="real-time">
      <div class="rt-item">
        <div class="rt-label">Temperatura actual</div>
        <div id="tempActual" class="rt-value">-- ¬∞C</div>
      </div>
      <div class="rt-item">
        <div class="rt-label">Humedad actual</div>
        <div id="humActual" class="rt-value">-- %</div>
      </div>
      <div class="rt-item">
        <div class="rt-label">√öltima lectura</div>
        <div id="horaLectura" class="rt-value">--:--:--</div>
      </div>
    </div>

    <canvas id="grafico"></canvas>

    <h2>üìÜ Hist√≥rico Diario (Comparador de d√≠as)</h2>
    <div style="margin-bottom:10px;">
      <input type="date" id="fechaComparar">
      <button id="limpiarComparaciones">üßπ Limpiar comparaciones</button>
      <button onclick="window.open('/generar_pdf', '_blank')">üìÑ Descargar informe PDF</button>
    </div>
    <canvas id="historico"></canvas>
  </main>

  <footer>Desarrollado por Nicol√°s Vald√©s ¬© 2025</footer>

  <script>
  // ====== TEMAS ======
  const temas = {
    oscuro:{bg:"#0d1b2a",card:"#1b263b",text:"#e0e1dd",accent:"#00b4d8"},
    claro:{bg:"#f0f0f0",card:"#ffffff",text:"#202020",accent:"#0077b6"},
    eco:{bg:"#0a3d2d",card:"#14532d",text:"#eaffea",accent:"#00c853"},
    solar:{bg:"#fff4e6",card:"#ffe5b4",text:"#4b2e05",accent:"#ff9800"},
    nocturno:{bg:"#1c0f33",card:"#2d1b4c",text:"#e3d7ff",accent:"#a46bf5"},
    industrial:{bg:"#2b2b2b",card:"#3c3c3c",text:"#f0f0f0",accent:"#e63946"}
  };

  const selectTema=document.getElementById("tema");
  function aplicarTema(nombre){
    const t=temas[nombre];
    if(!t)return;
    document.documentElement.style.setProperty("--bg",t.bg);
    document.documentElement.style.setProperty("--card",t.card);
    document.documentElement.style.setProperty("--text",t.text);
    document.documentElement.style.setProperty("--accent",t.accent);
    localStorage.setItem("temaSeleccionado",nombre);
  }
  const guardado=localStorage.getItem("temaSeleccionado")||"oscuro";
  aplicarTema(guardado);
  selectTema.value=guardado;
  selectTema.addEventListener("change",e=>aplicarTema(e.target.value));

  // ====== GR√ÅFICO EN VIVO ======
  const ctx=document.getElementById('grafico').getContext('2d');
  const grafico=new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[
      {label:'Temperatura (¬∞C)',data:[],borderColor:'#ff6b6b',fill:false},
      {label:'Humedad (%)',data:[],borderColor:'#48cae4',fill:false}
    ]},
    options:{animation:false,responsive:true}
  });

  let ultimaHoraPromedio = null;

  async function actualizar(){
    const resp=await fetch('/data');
    const d=await resp.json();
    if(!d)return;

    const hora=new Date().toLocaleTimeString();
    document.getElementById('tempActual').innerText=`${d.temperatura.toFixed(2)} ¬∞C`;
    document.getElementById('humActual').innerText=`${d.humedad.toFixed(2)} %`;
    document.getElementById('horaLectura').innerText=hora;

    if (!ultimaHoraPromedio || (new Date() - ultimaHoraPromedio) >= 10*60*1000 || d.promedio === true) {
      grafico.data.labels.push(hora);
      grafico.data.datasets[0].data.push(d.temperatura);
      grafico.data.datasets[1].data.push(d.humedad);
      if(grafico.data.labels.length>30){
        grafico.data.labels.shift();
        grafico.data.datasets.forEach(ds=>ds.data.shift());
      }
      grafico.update();
      ultimaHoraPromedio = new Date();
    }
  }

  // ====== HIST√ìRICO ======
  const ctxHist=document.getElementById('historico').getContext('2d');
  const graficoHist=new Chart(ctxHist,{
    type:'line',
    data:{labels:[],datasets:[]},
    options:{responsive:true}
  });

  let comparaciones=[];

  async function actualizarHistorico(){
    const r=await fetch('/historico_data');
    const h=await r.json();
    if(h.error)return;
    const baseDatasets=[
      {label:"Temp. promedio hoy (¬∞C)",data:h.temp_mean,borderColor:"#00b4d8",fill:false},
      {label:"Hum. promedio hoy (%)",data:h.hum_mean,borderColor:"#48cae4",fill:false}
    ];
    graficoHist.data.labels=h.fechas;
    graficoHist.data.datasets=[...baseDatasets,...comparaciones];
    graficoHist.update();
  }

  async function compararFecha(fecha){
    const r=await fetch(`/historico_por_fecha/${fecha}`);
    const h=await r.json();
    if(h.error)return alert("No hay datos para esa fecha.");
    comparaciones.push(
      {label:`Temp. comparado ${fecha}`,data:h.temp_mean,borderColor:"#ffb703",borderDash:[5,5],fill:false},
      {label:`Hum. comparado ${fecha}`,data:h.hum_mean,borderColor:"#fb8500",borderDash:[5,5],fill:false}
    );
    graficoHist.data.datasets=[...graficoHist.data.datasets,...comparaciones];
    graficoHist.update();

    // üîπ Enviar las fechas comparadas al servidor Flask
    const fechas = comparaciones.map(ds => ds.label.match(/\d{4}-\d{2}-\d{2}/)?.[0]).filter(Boolean);
    await fetch("/set_fechas_comparadas", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ fechas })
    });
  }

  document.getElementById('limpiarComparaciones').addEventListener('click',async ()=>{
    comparaciones=[];
    await fetch("/set_fechas_comparadas", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ fechas: [] })
    });
    actualizarHistorico();
  });

  document.getElementById('fechaComparar').addEventListener('change',e=>compararFecha(e.target.value));

  // ====== EXTREMOS ======
  async function actualizarExtremos(){
    const r=await fetch('/extremos');
    const e=await r.json();
    if(e.error)return;
    document.getElementById('tmax').innerText=e.temp_max.toFixed(2);
    document.getElementById('tmin').innerText=e.temp_min.toFixed(2);
    document.getElementById('hmax').innerText=e.hum_max.toFixed(2);
    document.getElementById('hmin').innerText=e.hum_min.toFixed(2);
    document.getElementById('tmean').innerText=e.temp_mean.toFixed(2);
    document.getElementById('tstd').innerText=e.temp_std.toFixed(2);
    document.getElementById('hmean').innerText=e.hum_mean.toFixed(2);
    document.getElementById('hstd').innerText=e.hum_std.toFixed(2);
  }
// ====== CLIMA EXTERNO (API OpenWeatherMap) ======
async function actualizarClimaExterno() {
  try {
    const r = await fetch("/clima_externo");
    const d = await r.json();
    const div = document.getElementById("climaExterno");
    const panel = document.getElementById("panelClima");

    if (d.error) {
      div.innerText = "No disponible.";
      panel.style.background = "#444";
      return;
    }

    div.innerText = `üå§Ô∏è ${d.temp.toFixed(1)} ¬∞C | üíß ${d.hum}% | ${d.desc}`;

    // Cambia color del panel seg√∫n temperatura
    if (d.temp < 20) {
      panel.style.background = "#2a4d7a"; // azul fr√≠o
    } else if (d.temp > 30) {
      panel.style.background = "#7a2a2a"; // rojo c√°lido
    } else {
      panel.style.background = "#2a7a4d"; // verde templado
    }

  } catch (err) {
    document.getElementById("climaExterno").innerText = "Error obteniendo datos.";
  }
}

  // ====== INTERVALOS ======
  setInterval(actualizar,60000);
  setInterval(actualizarHistorico,600000);
  setInterval(actualizarExtremos,30000);
  setInterval(actualizarAlerta,30000);


  actualizarHistorico();
  actualizarExtremos();
  actualizarClimaExterno();
  // ====== ALERTAS DE UMBRALES ======
async function actualizarAlerta() {
  try {
    const r = await fetch("/alerta");
    const d = await r.json();
    const panel = document.getElementById("alertaPanel");

    if (d.temp || d.hum) {
      panel.style.display = "block";
      panel.innerText = d.msg || "‚ö†Ô∏è Condiciones fuera de rango.";
    } else {
      panel.style.display = "none";
    }
  } catch (err) {
    console.log("Error verificando alerta:", err);
  }
}

// Verifica cada 30 segundos
setInterval(actualizarAlerta, 30000);
actualizarAlerta();

  </script>
</body>
</html>
